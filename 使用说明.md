# InfiniteTalk 多图数字人使用说明

## 📖 目录

1. [简介](#简介)
2. [快速参考表](#快速参考表)
3. [安装步骤](#安装步骤)
4. [快速开始](#快速开始)
5. [节点详细说明](#节点详细说明)
6. [工作流示例](#工作流示例)
7. [常见问题](#常见问题)
8. [注意事项](#注意事项)

---

## 快速参考表

### 核心节点速查

| 节点名称 | 主要功能 | 关键参数 | 常用场景 |
|---------|---------|---------|---------|
| **InfiniteTalkMultiImage** | 多图输入和时间控制 | `audio_duration`, `start_time1-20`, `prompt_list_input` | 设置多张图片的开始时间和提示词 |
| **InfiniteTalkEmbedsSlice** | 音频嵌入切片 | `start_video_frame`, `video_frame_length` | 将长音频切分成片段处理 |
| **VideoFromPathsAndAudio** | 视频合成 | `image_paths`, `frame_counts`, `transition_type` | 将图片序列合成为视频 |
| **MakeBatchFromIntList** | 整数列表合并 | `int_list` | 合并多个整数值 |
| **GetIntByIndex** | 获取整数 | `int_batch`, `index` | 从批次中提取指定索引的值 |
| **MakeBatchFromFloatList** | 浮点数列表合并 | `float_list` | 合并多个浮点数值 |
| **GetFloatByIndex** | 获取浮点数 | `float_batch`, `index` | 从批次中提取指定索引的值 |

### 过渡效果速查

| 效果名称 | 视觉效果 | 适用场景 |
|---------|---------|---------|
| `crossfade` | 淡入淡出 | 通用，最自然 |
| `left_wipe` | 从左向右擦除 | 强调方向性 |
| `right_wipe` | 从右向左擦除 | 强调方向性 |
| `slide_left` | 向左滑动 | 动态感强 |
| `slide_right` | 向右滑动 | 动态感强 |
| `zoom_in` | 放大进入 | 强调重点 |
| `zoom_out` | 缩小退出 | 退出效果 |
| `soft_blur` | 模糊过渡 | 柔和过渡 |
| `random` | 随机效果 | 多样化 |

---

## 简介

**InfiniteTalk 多图数字人** 是一个 ComfyUI 插件，可以让你：
- ✅ 使用多张图片创建数字人视频
- ✅ 为每张图片指定不同的开始时间
- ✅ 为每张图片设置独立的提示词（Prompt）
- ✅ 生成无限长视频，显存占用不会随视频时长增加
- ✅ 支持多种图片过渡效果（淡入淡出、滑动、缩放等）
- ✅ 完全兼容 KJ 节点，无需修改原有节点

---

## 安装步骤

### 前置要求

1. **已安装 ComfyUI**
   - 确保你的 ComfyUI 可以正常运行

2. **安装依赖**
   ```bash
   # 进入插件目录
   cd ComfyUI-InfiniteTalk-MultiImage
   
   # 安装 Python 依赖
   pip install -r requirements.txt
   ```

3. **安装 FFmpeg**（用于视频合成）
   - Windows: 下载 [FFmpeg](https://ffmpeg.org/download.html) 并添加到系统 PATH
   - 验证安装: 在命令行运行 `ffmpeg -version`

### 安装插件

1. 将 `ComfyUI-InfiniteTalk-MultiImage` 文件夹复制到 ComfyUI 的 `custom_nodes` 目录
2. 重启 ComfyUI
3. 在节点菜单中找到 `InfiniteTalk` 分类，说明安装成功

---

## 快速开始

### 基本流程

1. **准备素材**
   - 准备一张或多张人物图片（建议分辨率一致）
   - 准备一个音频文件（.wav 格式）

2. **加载工作流**
   - 打开 ComfyUI
   - 加载 `InfiniteTalk 图片数字人--多图.json` 工作流文件

3. **设置参数**
   - 在 `InfiniteTalkMultiImage` 节点中：
     - 输入音频时长（秒）
     - 连接多张图片
     - 设置每张图片的开始时间
     - 输入提示词（每行一个）

4. **运行生成**
   - 点击 "Queue Prompt" 开始生成
   - 等待完成后，在输出目录查看生成的视频

### 参数设置技巧

#### 时间设置建议

**等时长分布**（推荐新手）:
```
音频时长: 9.0 秒
图片1: 0.0 秒
图片2: 3.0 秒
图片3: 6.0 秒
```
每张图片显示 3 秒，简单明了。

**不等时长分布**:
```
音频时长: 10.0 秒
图片1: 0.0 秒  (显示 4 秒)
图片2: 4.0 秒  (显示 3 秒)
图片3: 7.0 秒  (显示 3 秒)
```
可以根据内容重要性分配时长。

#### 提示词编写建议

**格式**: 每行一个提示词，对应一张图片

**示例**:
```
正面，微笑，自然表情
看向镜头，眨眼，轻微点头
挥手，打招呼，保持微笑
```

**技巧**:
- 描述具体的动作和表情
- 保持简洁，避免过长
- 如果某张图片不需要特殊控制，可以留空

#### 过渡效果选择建议

- **日常使用**: `crossfade`（淡入淡出，最自然）
- **需要动感**: `slide_left` 或 `slide_right`
- **强调重点**: `zoom_in`
- **想要多样化**: `random`（每次随机选择）

---

## 节点详细说明

### 1. InfiniteTalkMultiImage（核心节点）

**功能**: 处理多张图片输入，计算每张图片的帧数和开始时间。

#### 输入参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `audio_duration` | FLOAT | 音频总时长（秒） | 8.0 |
| `prompt_list_input` | STRING | 提示词列表，每行一个，对应每张图片 | "" |
| `image1` ~ `image20` | IMAGE | 最多支持 20 张图片输入 | - |
| `start_time1` ~ `start_time20` | FLOAT | 每张图片的开始时间（秒），步长 0.04 | 0.0, 3.0, 6.0... |
| `auto_start_time_list` | START_TIME_LIST | 自动时间列表（可选，会覆盖手动设置的时间） | [] |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `image_list` | IMAGE | 处理后的图片列表 |
| `frame_count_list` | INT | 每张图片对应的帧数列表 |
| `real_start_time_list` | FLOAT | 实际使用的开始时间列表 |
| `prompt_list` | STRING | 对齐后的提示词列表 |

#### 使用示例

```
音频时长: 10.0 秒
图片1: 开始时间 0.0 秒
图片2: 开始时间 3.0 秒
图片3: 开始时间 6.0 秒

提示词:
微笑，自然表情
看向镜头，眨眼
挥手，打招呼
```

**工作原理**:
- 根据音频时长和每张图片的开始时间，自动计算每张图片需要生成的帧数
- 如果图片的开始时间超过音频时长，该图片会被自动过滤
- 提示词会自动对齐到图片数量（不足用空字符串填充，多余会截断）

---

### 2. InfiniteTalkEmbedsSlice（嵌入切片节点）

**功能**: 将音频嵌入（embeds）按视频帧区间进行切片。

#### 输入参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `multitalk_embeds` | MULTITALK_EMBEDS | 音频嵌入数据 | - |
| `start_video_frame` | INT | 视频起始帧号 | 0 |
| `video_frame_length` | INT | 视频帧长度 | 30 |
| `fps` | INT | 视频帧率（1-120） | 25 |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `sliced_multitalk_embeds` | MULTITALK_EMBEDS | 切片后的音频嵌入 |

#### 使用说明

- 该节点用于将长音频的嵌入数据切分成多个片段
- 音频嵌入的帧率固定为 25 帧/秒
- 节点会自动将视频帧区间转换为对应的音频帧区间

**示例**:
```
视频帧: 0-30 (30帧)
视频帧率: 25 fps
音频帧率: 25 fps

结果: 音频嵌入的 0-30 帧
```

---

### 3. VideoFromPathsAndAudio（视频合成节点）

**功能**: 将图片序列和音频合成为视频，支持多种过渡效果。

#### 输入参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `image_paths` | STRING | 图片路径列表，每行一个（支持文件夹或文件） | "" |
| `frame_counts` | STRING | 每行对应路径的帧数 | "" |
| `audio` | AUDIO | 音频输入 | - |
| `fps` | INT | 输出视频帧率（1-120） | 25 |
| `filename_prefix` | STRING | 输出文件名前缀 | "video_output" |
| `format` | SELECT | 输出格式: mp4/mkv/mov | "mp4" |
| `enable_transition` | BOOLEAN | 是否启用过渡效果 | True |
| `transition_seconds` | FLOAT | 过渡时长（秒，0.05-5.0） | 0.5 |
| `transition_type` | SELECT | 过渡类型（见下方） | "crossfade" |

#### 过渡类型说明

| 类型 | 效果描述 |
|------|----------|
| `crossfade` | 淡入淡出（最常用，自然平滑） |
| `left_wipe` | 从左向右擦除 |
| `right_wipe` | 从右向左擦除 |
| `slide_left` | 向左滑动（新图从右侧滑入） |
| `slide_right` | 向右滑动（新图从左侧滑入） |
| `zoom_in` | 放大进入（新图从 70% 放大到 100%） |
| `zoom_out` | 缩小退出（旧图缩小，新图显示） |
| `soft_blur` | 模糊过渡（旧图逐渐模糊，新图清晰） |
| `random` | 随机选择过渡效果 |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `video_path` | STRING | 生成的视频文件路径 |

#### 使用示例

**图片路径格式**:
```
D:\images\frame_001.png
D:\images\frame_002.png
D:\images\frame_003.png
```

**帧数格式**（每行对应一个路径）:
```
10
15
20
```

**文件夹支持**:
```
D:\images\folder1
D:\images\folder2
```

节点会自动读取文件夹中的所有图片（支持 png, jpg, jpeg, bmp, webp）。

---

### 4. MakeBatchFromIntList（整数列表转批次）

**功能**: 将多个整数输入合并成一个批次（batch）。

#### 输入参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| `int_list` | INT | 整数列表（支持多个输入） |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `int_batch` | INT | 合并后的整数批次 |

#### 使用说明

- 用于将多个单独的整数值合并成一个批次
- 如果只有一个输入，直接返回
- 多个输入会转换为 PyTorch tensor

---

### 5. GetIntByIndex（按索引获取整数）

**功能**: 从整数批次中获取指定索引的值。

#### 输入参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `int_batch` | INT | 整数批次 | - |
| `index` | INT | 要获取的索引（从 0 开始） | 0 |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `value` | INT | 指定索引的整数值 |

#### 使用说明

- 如果索引超出范围，会返回边界值（第一个或最后一个）
- 如果批次为空，返回 0

---

### 6. MakeBatchFromFloatList（浮点数列表转批次）

**功能**: 将多个浮点数输入合并成一个批次。

#### 输入参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| `float_list` | FLOAT | 浮点数列表（支持多个输入） |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `float_batch` | FLOAT | 合并后的浮点数批次 |

#### 使用说明

- 与 `MakeBatchFromIntList` 类似，但处理浮点数
- 用于合并多个浮点数值

---

### 7. GetFloatByIndex（按索引获取浮点数）

**功能**: 从浮点数批次中获取指定索引的值。

#### 输入参数

| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `float_batch` | FLOAT | 浮点数批次 | - |
| `index` | INT | 要获取的索引（从 0 开始） | 0 |

#### 输出参数

| 输出名 | 类型 | 说明 |
|--------|------|------|
| `value` | FLOAT | 指定索引的浮点数值 |

#### 使用说明

- 如果索引超出范围，会返回边界值
- 如果批次为空，返回 0.0

---

## 工作流示例

### 示例 1: 三张图片，每张 3 秒

**设置**:
- 音频时长: 9.0 秒
- 图片1: 开始时间 0.0 秒
- 图片2: 开始时间 3.0 秒
- 图片3: 开始时间 6.0 秒

**提示词**:
```
微笑，自然表情
看向镜头，眨眼
挥手，打招呼
```

**结果**: 每张图片显示 3 秒，共 9 秒视频。

---

### 示例 2: 两张图片，不同时长

**设置**:
- 音频时长: 10.0 秒
- 图片1: 开始时间 0.0 秒（显示 5 秒）
- 图片2: 开始时间 5.0 秒（显示 5 秒）

**提示词**:
```
正面，微笑
侧面，转头
```

**结果**: 第一张图片显示 5 秒，第二张图片显示 5 秒。

---

### 示例 3: 使用过渡效果

**设置**:
- 启用过渡: ✅
- 过渡时长: 0.5 秒
- 过渡类型: `crossfade`（淡入淡出）

**效果**: 图片切换时会有 0.5 秒的平滑过渡，不会突然切换。

---

## 常见问题

### Q1: 为什么我的图片没有被使用？

**可能原因**:
1. 图片的开始时间超过了音频时长
2. 图片没有正确连接到节点

**解决方法**:
- 检查 `audio_duration` 是否大于所有图片的开始时间
- 确保图片节点正确连接到 `InfiniteTalkMultiImage` 节点

---

### Q2: 提示词数量不够怎么办？

**说明**: 如果提示词数量少于图片数量，不足的部分会用空字符串填充。

**建议**: 为每张图片都写一个提示词，以获得更好的控制效果。

---

### Q3: 过渡效果不生效？

**检查项**:
1. `enable_transition` 是否设置为 `True`
2. 是否有多个图片段（单张图片无法过渡）
3. 过渡时长是否合理（建议 0.3-1.0 秒）

---

### Q4: 视频生成失败，提示 FFmpeg 错误？

**解决方法**:
1. 确认 FFmpeg 已正确安装并添加到 PATH
2. 在命令行运行 `ffmpeg -version` 验证
3. 检查输出目录是否有写入权限

---

### Q5: 显存不足怎么办？

**建议**:
1. 使用 `InfiniteTalk 图片数字人--多图--低显存16G版本.json` 工作流
2. 减少同时处理的图片数量
3. 降低图片分辨率
4. 使用较小的批次大小

---

### Q6: 时间精度问题

**说明**: 
- 开始时间的最小步长是 0.04 秒（对应 25 fps 的 1 帧）
- 输入的时间会自动对齐到 0.04 的倍数

**示例**:
- 输入 3.05 秒 → 自动对齐为 3.04 秒
- 输入 3.07 秒 → 自动对齐为 3.08 秒

---

## 注意事项

### ⚠️ 重要提示

1. **时间设置**
   - 开始时间必须小于音频时长
   - 建议按时间顺序排列图片（0秒 → 3秒 → 6秒...）

2. **图片格式**
   - 支持常见图片格式：PNG, JPG, JPEG, BMP, WEBP
   - 建议所有图片分辨率一致，避免尺寸问题

3. **音频格式**
   - 建议使用 WAV 格式
   - 确保音频时长准确

4. **过渡效果**
   - 过渡时长不要设置过长（建议 0.3-1.0 秒）
   - 过渡会占用图片的显示时间，注意计算

5. **性能优化**
   - 如果显存不足，使用低显存版本工作流
   - 大批量处理时，建议分批生成

6. **文件路径**
   - Windows 路径使用反斜杠 `\` 或正斜杠 `/` 都可以
   - 路径中包含空格时，建议用引号包裹

---

## 技术支持

如果遇到问题：
1. 检查 ComfyUI 控制台的错误信息
2. 确认所有依赖已正确安装
3. 查看工作流示例文件，对比设置

---

## 更新日志

- **v1.0**: 初始版本
  - 支持多图输入
  - 支持时间控制
  - 支持提示词控制
  - 支持多种过渡效果

---

**祝你使用愉快！** 🎉

